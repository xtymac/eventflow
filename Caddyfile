# Caddyfile for EventFlow production
eventflow.uixai.org {
    # Static PMTiles files - serve from web container (long cache)
    handle /tiles/*.pmtiles {
        header Cache-Control "public, max-age=86400"
        reverse_proxy web:5173
    }

    # Dynamic vector tiles from Martin (short cache for real-time data)
    handle /tiles/* {
        header Cache-Control "public, max-age=300"
        uri strip_prefix /tiles
        reverse_proxy martin:3000
    }

    # API endpoints
    handle /api/* {
        uri strip_prefix /api
        reverse_proxy api:3000
    }

    # OGC API endpoints (no prefix strip - routes are /ogc/...)
    @ogc path /ogc /ogc/*
    handle @ogc {
        reverse_proxy api:3000
    }

    # SSE endpoints (no buffering)
    handle /sse/* {
        uri strip_prefix /sse
        reverse_proxy api:3000 {
            flush_interval -1
        }
    }

    # Frontend (Vite dev server in Docker)
    # Catch-all for frontend - explicitly excludes API/backend paths
    @frontend {
        not path /api/*
        not path /ogc /ogc/*
        not path /sse/*
        not path /tiles/*
        not path /.well-known/*
    }
    handle @frontend {
        reverse_proxy web:5173
    }

    # Enable compression
    encode gzip

    # Logging
    log {
        output stdout
        format console
    }
}

# v1 frozen version - uses container names (not service names) since it's a separate compose project
v1.eventflow.uixai.org {
    handle /tiles/*.pmtiles {
        header Cache-Control "public, max-age=86400"
        reverse_proxy nagoya-web-v1:5173
    }

    handle /tiles/* {
        header Cache-Control "public, max-age=300"
        uri strip_prefix /tiles
        reverse_proxy nagoya-martin-v1:3000
    }

    handle /api/* {
        uri strip_prefix /api
        reverse_proxy nagoya-api-v1:3000
    }

    @ogc path /ogc /ogc/*
    handle @ogc {
        reverse_proxy nagoya-api-v1:3000
    }

    handle /sse/* {
        uri strip_prefix /sse
        reverse_proxy nagoya-api-v1:3000 {
            flush_interval -1
        }
    }

    @frontend {
        not path /api/*
        not path /ogc /ogc/*
        not path /sse/*
        not path /tiles/*
        not path /.well-known/*
    }
    handle @frontend {
        reverse_proxy nagoya-web-v1:5173
    }

    encode gzip

    log {
        output stdout
        format console
    }
}

# Urban Infrastructure DX Platform (demo)
demo.eventflow.uixai.org {
    handle {
        reverse_proxy uidx-server:8080
    }

    encode gzip

    log {
        output stdout
        format console
    }
}
